<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>í´ë˜ìŠ¤ì–´ë¼ìš´ë“œ Â· ë“œë¼ì´ë¸Œ í´ë” ëª¨ìŒ</title>

  <!-- Tailwind (ì´ë¯¸ ë‹¤ë¥¸ í˜ì´ì§€ì—ì„œ ì“°ë©´ ì¤‘ë³µ ì œê±° ê°€ëŠ¥) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Google Identity Services (OAuthìš©) -->
  <script src="https://accounts.google.com/gsi/client" async defer></script>

  <style>
    body { background:#f8fafc; }
    .folder-btn{transition:.15s}
    .folder-btn:hover{background:#e5f0ff}
    .file-row:hover{background:#f1f5f9}
  </style>
</head>
<body class="min-h-screen text-slate-900">
  <div class="max-w-6xl mx-auto px-4 py-6">
    <!-- í—¤ë” -->
    <header class="flex items-center justify-between mb-6">
      <div>
        <h1 class="text-2xl font-bold">í´ë˜ìŠ¤ì–´ë¼ìš´ë“œ ìš´ì˜ ëŒ€ì‹œë³´ë“œ</h1>
        <p class="text-sm text-slate-500">
          ì¹´ì¹´ì˜¤í†¡ ì…ì¥ì ì²´í¬ Â· ìˆ˜ê°•ìƒ ì‹œíŠ¸ ì—…ë°ì´íŠ¸ Â· ë“œë¼ì´ë¸Œ ìë£Œ ëª¨ìŒ
        </p>
      </div>
      <div class="text-right text-xs text-slate-500 space-y-1">
        <div id="login-status">ğŸ”’ Google Drive ë¯¸ë¦¬ë³´ê¸° ë¯¸ì—°ê²°</div>
        <button id="btn-drive-connect"
                class="mt-1 px-3 py-1 rounded-md border border-slate-300 text-xs font-medium hover:bg-slate-100">
          ë“œë¼ì´ë¸Œ ë¯¸ë¦¬ë³´ê¸° ì‚¬ìš© ì„¤ì •
        </button>
      </div>
    </header>

    <div class="grid grid-cols-[260px,1fr] gap-4">
      <!-- ì™¼ìª½: í´ë” ë¦¬ìŠ¤íŠ¸ -->
      <aside class="bg-white rounded-2xl shadow border border-slate-100 p-4">
        <div class="flex items-center mb-3">
          <span class="text-xl mr-2">ğŸ“‚</span>
          <div>
            <p class="text-sm font-semibold">ë“œë¼ì´ë¸Œ í´ë” ëª¨ìŒ</p>
            <p class="text-xs text-slate-500">
              ì¢Œì¸¡ì—ì„œ í´ë” ì„ íƒ í›„ ìš°ì¸¡ì—ì„œ íŒŒì¼ ë¯¸ë¦¬ë³´ê¸°
            </p>
          </div>
        </div>

        <div id="folder-list" class="space-y-1 text-sm">
          <!-- JSë¡œ í´ë” ë²„íŠ¼ ë Œë”ë§ -->
        </div>
      </aside>

      <!-- ì˜¤ë¥¸ìª½: íŒŒì¼ ë¯¸ë¦¬ë³´ê¸° -->
      <main class="bg-white rounded-2xl shadow border border-slate-100 p-4 flex flex-col">
        <div class="flex items-center justify-between mb-3">
          <div>
            <p class="text-xs text-slate-400">DRIVE FOLDER VIEW</p>
            <p id="current-folder-title" class="text-base font-semibold mt-1">
              í´ë”ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”
            </p>
            <p id="current-folder-desc" class="text-xs text-slate-500">
              ì¢Œì¸¡ì—ì„œ í´ë”ë¥¼ í´ë¦­í•˜ë©´ ì´ ì˜ì—­ì— íŒŒì¼ ëª©ë¡ì´ í‘œì‹œë©ë‹ˆë‹¤.
            </p>
          </div>
          <button id="btn-open-newtab"
                  class="px-3 py-1 rounded-full border border-slate-200 text-xs text-slate-600 hover:bg-slate-50 disabled:opacity-40 disabled:cursor-not-allowed"
                  disabled>
            ìƒˆ íƒ­ì—ì„œ í´ë” ì—´ê¸°
          </button>
        </div>

        <div id="drive-preview"
             class="mt-2 flex-1 border border-slate-100 rounded-xl bg-slate-50 overflow-auto">
          <div class="h-full flex flex-col items-center justify-center text-slate-400 text-sm px-6 text-center">
            <p class="mb-2">ğŸ“ ì™¼ìª½ì—ì„œ í´ë”ë¥¼ ì„ íƒí•˜ë©´ íŒŒì¼ ëª©ë¡ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</p>
            <p class="text-xs">
              ë“œë¼ì´ë¸Œ ê¶Œí•œì€ ê·¸ëŒ€ë¡œ ìœ ì§€ë˜ê³ , ì´ í˜ì´ì§€ì—ì„œëŠ” íŒŒì¼ ì œëª©ë§Œ ë¯¸ë¦¬ ë³´ì—¬ì¤ë‹ˆë‹¤.
            </p>
          </div>
        </div>
      </main>
    </div>
  </div>

  <script>
    // ==============================
    // 1. í´ë” ëª©ë¡ (ë„¤ê°€ ì¤€ ë§í¬ì—ì„œ IDë§Œ ì¶”ì¶œ)
    // ==============================
    const FOLDERS = [
      {
        key: 'card',
        name: 'í˜„ê¸ˆê²°ì œ êµ¬ê¸€í¼',
        desc: 'í˜„ê¸ˆ/ê³„ì¢Œ ê²°ì œ ì‘ë‹µ ëª¨ìŒ',
        id: '1LdDYVwxDrpqpPy2HYlSnrw2w7YKhsKWF'
      },
      {
        key: 'share',
        name: 'ê°•ì‚¬ ê³µìœ ìš© ì‹œíŠ¸',
        desc: 'ê°•ì‚¬ì§„ ê³µìœ  ì‹œíŠ¸ & ìë£Œ',
        id: '1t33dy_UQCfsvoEQ9yOctIxvoT623i-j4'
      },
      {
        key: 'ebook',
        name: 'ë¬´ë£Œê°•ì˜ ì „ìì±… êµ¬ê¸€í¼',
        desc: 'ë¬´ë£Œ ì „ìì±… ì‹ ì²­ ì‘ë‹µ',
        id: '1C1OsgYqZtxauLNN9l4mRHPgaIavrhmq-'
      },
      {
        key: 'qna',
        name: 'ë¬´ë£Œê°•ì˜ ì‚¬ì „ ì§ˆë¬¸',
        desc: 'ë¬´ë£Œê°•ì˜ Q&A / ì‚¬ì „ì§ˆë¬¸ ëª¨ìŒ',
        id: '1BU7ugKEeRXmG3PoRGJqKHlxuVtgT2_js'
      },
      {
        key: 'live',
        name: 'ë¼ì´ë¸Œ ìë£Œ',
        desc: 'ë¼ì´ë¸Œ ë°©ì†¡ ìë£Œ Â· PPT ëª¨ìŒ',
        id: '1Ej6eIw0WwCn8NxtwW5A4vj8wo2xyKATC'
      }
    ];

    // ==============================
    // 2. ì „ì—­ ìƒíƒœ
    // ==============================
    const CLIENT_ID =
      '18228268359-iifm4ck3j9kqj74eh1p90tco1k2mbpi0.apps.googleusercontent.com';

    let driveTokenClient = null;
    let driveAccessToken = null;
    let pendingFolderId = null;
    let currentFolder = null;

    // ==============================
    // 3. í´ë” ë²„íŠ¼ ë Œë”ë§
    // ==============================
    function renderFolderList() {
      const listEl = document.getElementById('folder-list');
      listEl.innerHTML = '';

      FOLDERS.forEach(folder => {
        const btn = document.createElement('button');
        btn.className =
          'folder-btn w-full text-left px-3 py-2 rounded-xl border border-slate-100 bg-slate-50 ' +
          'hover:border-sky-300 text-sm flex items-center justify-between';
        btn.innerHTML = `
          <div>
            <div class="font-medium">${folder.name}</div>
            <div class="text-[11px] text-slate-500">${folder.desc}</div>
          </div>
          <span class="text-[11px] px-2 py-0.5 rounded-full bg-white border border-slate-200">ì—´ê¸°</span>
        `;
        btn.onclick = () => onFolderClick(folder);
        listEl.appendChild(btn);
      });
    }

    // ==============================
    // 4. OAuth ì´ˆê¸°í™”
    // ==============================
    function initDriveOAuth() {
      if (!window.google || !google.accounts || !google.accounts.oauth2) {
        console.error('Google Identity Services ë¡œë”© ì „ì…ë‹ˆë‹¤.');
        return;
      }

      driveTokenClient = google.accounts.oauth2.initTokenClient({
        client_id: CLIENT_ID,
        scope: 'https://www.googleapis.com/auth/drive.readonly',
        callback: (tokenResponse) => {
          driveAccessToken = tokenResponse.access_token;
          document.getElementById('login-status').textContent =
            'âœ… Google Drive ë¯¸ë¦¬ë³´ê¸° ì—°ê²°ë¨';

          if (pendingFolderId) {
            const folder = FOLDERS.find(f => f.id === pendingFolderId);
            pendingFolderId = null;
            if (folder) listFilesInFolder(folder);
          }
        }
      });
    }

    function requestDriveAccess() {
      if (!driveTokenClient) initDriveOAuth();
      if (!driveTokenClient) {
        alert('Google OAuth ì´ˆê¸°í™”ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
        return;
      }
      if (driveAccessToken) {
        document.getElementById('login-status').textContent =
          'âœ… Google Drive ë¯¸ë¦¬ë³´ê¸° ì—°ê²°ë¨';
        return;
      }
      driveTokenClient.requestAccessToken({ prompt: '' });
    }

    // ==============================
    // 5. í´ë” í´ë¦­ & íŒŒì¼ ëª©ë¡
    // ==============================
    function onFolderClick(folder) {
      currentFolder = folder;

      document.getElementById('current-folder-title').textContent = folder.name;
      document.getElementById('current-folder-desc').textContent = folder.desc;

      const openBtn = document.getElementById('btn-open-newtab');
      openBtn.disabled = false;
      openBtn.onclick = () => {
        window.open(
          `https://drive.google.com/drive/folders/${folder.id}`,
          '_blank'
        );
      };

      if (!driveAccessToken) {
        pendingFolderId = folder.id;
        requestDriveAccess();
      } else {
        listFilesInFolder(folder);
      }
    }

   async function listFilesInFolder(folder) {
  const previewEl = document.getElementById('drive-preview');
  previewEl.innerHTML = `
    <div class="p-4 text-sm text-slate-500">
      <span class="animate-pulse">íŒŒì¼ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</span>
    </div>
  `;

  try {
    const params = new URLSearchParams({
      q: `'${folder.id}' in parents and trashed = false`,
      fields:
        'files(id,name,mimeType,iconLink,webViewLink,modifiedTime,size)',
      pageSize: '200',
      orderBy: 'folder,name,modifiedTime desc'
    });

    const res = await fetch(
      `https://www.googleapis.com/drive/v3/files?${params.toString()}`,
      {
        headers: { Authorization: `Bearer ${driveAccessToken}` }
      }
    );

    // â˜… í† í° ë§Œë£Œ
    if (res.status === 401) {
      console.warn('401 Unauthorized (token ë§Œë£Œ) â†’ ì¬ìš”ì²­');
      driveAccessToken = null;
      pendingFolderId = folder.id;
      requestDriveAccess();
      return;
    }

    const data = await res.json();

    // â˜… API ì‹¤íŒ¨(403, 400 ë“±)ë©´ ì—ëŸ¬ ë‚´ìš© ë³´ì—¬ì£¼ê¸°
    if (!res.ok) {
      console.error('Drive API error:', data);
      previewEl.innerHTML = `
        <div class="p-4 text-sm text-red-500 space-y-2">
          <div>Google Drive API í˜¸ì¶œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</div>
          <div class="text-xs text-slate-500">
            ìƒíƒœì½”ë“œ: ${res.status}<br>
            ë©”ì‹œì§€: ${data.error && data.error.message ? data.error.message : 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'}
          </div>
        </div>
      `;
      return;
    }

    const files = data.files || [];

    if (!files.length) {
      previewEl.innerHTML = `
        <div class="p-4 text-sm text-slate-500">
          ì´ í´ë”ì— í‘œì‹œí•  íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤.
        </div>
      `;
      return;
    }

    renderFileList(previewEl, files);
  } catch (err) {
    console.error(err);
    previewEl.innerHTML = `
      <div class="p-4 text-sm text-red-500">
        íŒŒì¼ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜ˆì™¸ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. (ë¸Œë¼ìš°ì € ì½˜ì†” ë¡œê·¸ í™•ì¸)
      </div>
    `;
  }
}

    function renderFileList(containerEl, files) {
      const rows = files
        .map(file => {
          const date = file.modifiedTime
            ? new Date(file.modifiedTime).toLocaleString()
            : '-';
          const sizeStr = file.size ? formatBytes(Number(file.size)) : '-';

          return `
            <button
              class="file-row w-full flex items-center text-left text-sm px-3 py-2 border-b border-slate-100 last:border-b-0"
              onclick="window.open('${file.webViewLink}', '_blank')"
            >
              <div class="flex-1 min-w-0">
                <div class="truncate font-medium text-slate-800">
                  ${escapeHtml(file.name)}
                </div>
                <div class="text-[11px] text-slate-500 mt-0.5">
                  ${file.mimeType} Â· ìˆ˜ì •: ${date}
                </div>
              </div>
              <div class="text-[11px] text-slate-500 ml-3 whitespace-nowrap">
                ${sizeStr}
              </div>
            </button>
          `;
        })
        .join('');

      containerEl.innerHTML = `
        <div
          class="text-[11px] text-slate-500 px-3 py-2 border-b border-slate-100 bg-slate-50/60 sticky top-0 z-10 flex justify-between"
        >
          <span>ì´ ${files.length}ê°œ íŒŒì¼</span>
          <span>í´ë¦­ ì‹œ ìƒˆ íƒ­ì—ì„œ ì—´ë¦½ë‹ˆë‹¤.</span>
        </div>
        <div>${rows}</div>
      `;
    }

    function formatBytes(bytes) {
      if (!bytes || bytes === 0) return '-';
      const units = ['B', 'KB', 'MB', 'GB', 'TB'];
      const i = Math.floor(Math.log(bytes) / Math.log(1024));
      const value = bytes / Math.pow(1024, i);
      return `${value.toFixed(1)} ${units[i]}`;
    }

    function escapeHtml(str) {
      return String(str)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;');
    }

    // ==============================
    // 6. onload
    // ==============================
    window.addEventListener('load', () => {
      renderFolderList();

      document.getElementById('btn-drive-connect').onclick = () => {
        requestDriveAccess();
      };

      if (window.google && google.accounts && google.accounts.oauth2) {
        initDriveOAuth();
      } else {
        const timer = setInterval(() => {
          if (window.google && google.accounts && google.accounts.oauth2) {
            initDriveOAuth();
            clearInterval(timer);
          }
        }, 300);
      }
    });
  </script>
</body>
</html>
